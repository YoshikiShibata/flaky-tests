# 月末境界による Flaky Test：月別設定値の切り替わり

## 概要

E2E テストで、月末（特に31日）にテストが失敗する現象が発生した。原因は、テスト内で時間を進める際に月をまたぐことで、月別のマスターデータ設定が変わり、期待値と実際の値が一致しなくなることにあった。

## 発生日時

- 2026年1月31日 05:32頃

## エラー内容

```
mismatch (-want +got):
- "rule_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",  // 1月のルールID
+ "rule_id": "yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy",  // 2月のルールID
- "amount": uint32(21000000),  // 1月の設定値
+ "amount": uint32(23000000),  // 2月の設定値
```

マスターデータから取得されるルールIDや設定値が期待値と異なっていた。

## 根本原因

### テストのロジック

テストでは以下のように時間を進めて2回目の操作を行う：

```go
secondOperationTime := now.Add(86400*time.Second + time.Second) // 1日 + 1秒後
```

### 問題の発生条件

1. テスト実行日が **1月31日** の場合
2. `now` = 2026年1月31日 05:32頃
3. `secondOperationTime` = 2026年**2月1日** 05:32頃（翌月）

### 月別マスターデータの違い

システムには月ごとに異なる設定値を持つマスターデータが存在する：

| 月 | 初期値 | 適用されるルール |
|----|--------|-----------------|
| 1月 | 14,000,000 | ルールA |
| 2月 | 16,000,000 | ルールB |

### 影響の連鎖

1. 2回目の操作が2月1日に実行される
2. システムが2月のマスターデータを参照する
3. 2月は設定値が異なる
4. 報酬ルールや報酬量が変わる
5. テストの期待値（1月の値）と実際の値（2月の値）が不一致

## 解決策

### 採用した修正

テスト内で使用する `now` を月初に固定し、時間を進めても月をまたがないようにする：

```go
// Before（問題あり）
now := time.Now()

// After（修正後）
now := time.Date(time.Now().Year(), time.Now().Month(), 1, 0, 0, 0, 0, time.Local)
```

これにより、1日 + 1秒後でも同じ月内に収まる。

### 代替案

1. **テスト用のマスターデータを固定する**: 月に依存しない固定値を使用する
2. **期待値を動的に計算する**: 実行時の月に応じて期待値を変える（複雑になりがち）
3. **月末を避けてテストを実行する**: CI/CD での実行タイミングを調整（根本解決にならない）

## 教訓

1. **時間に依存するテストは境界条件を考慮する**: 月末、年末、うるう年など
2. **テストの `now` を固定する場合は月初を使う**: 時間を進めても月をまたがない
3. **月別設定があるマスターデータに注意**: 設定値の違いがテスト結果に影響する
4. **テストは「いつ実行しても同じ結果」になるべき**: 実行日時に依存する暗黙の前提を排除する

## 分類

- **カテゴリ**: 時間境界問題（Time Boundary Issue）
- **サブカテゴリ**: 月別マスターデータ切り替わり
- **発生頻度**: 月末（特に31日）
- **重要度**: 中（月に1回程度の発生だが、CI/CD の信頼性に影響）

## 関連パターン

- [flaky-test-time-boundary-patterns.md](./flaky-test-time-boundary-patterns.md) - 時間境界に関する他のパターン
